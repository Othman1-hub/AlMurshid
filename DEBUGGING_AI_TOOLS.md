# تصحيح مشاكل أدوات المرشد (AI Tools Debugging)

## المشكلة الحالية
المرشد يحاول إنشاء مهام ولكن يفشل بسبب مشاكل في معرف المشروع أو المصادقة.

## الأسباب المحتملة

### 1. **مشكلة المصادقة (Authentication Issue)**
**المشكلة**: أدوات AI تعمل في Edge Runtime ولا تستطيع الوصول إلى جلسة المستخدم بشكل صحيح.

**الحل المطبق**:
- تحسين رسائل الخطأ في `lib/ai/tools.ts` للتحقق من معرف المشروع
- إضافة معلومات أوضح عن معرف المشروع في سياق المحادثة

### 2. **معرف مشروع غير صحيح**
**المشكلة**: AI قد يستخدم معرف مشروع خاطئ أو يحاول تخمين المعرف.

**الحل المطبق**:
- تحديث `ALMURSHID_ASSISTANT_PROMPT` لتوضيح ضرورة استخدام المعرف من السياق
- إضافة تحذير واضح في معلومات المشروع يوضح المعرف الصحيح

## خطوات التصحيح

### الخطوة 1: التحقق من معرف المشروع
1. افتح صفحة `/dashboard/[projectId]/ai`
2. انظر إلى URL - المعرف يجب أن يكون رقماً (مثل: `/dashboard/5/ai`)
3. تحقق من أن المعرف يظهر في معلومات المشروع أعلى الصفحة

### الخطوة 2: اختبار أداة بسيطة
اطلب من المرشد:
```
أعطني ملخص عن حالة المشروع
```
هذا لا يستخدم أدوات ويجب أن يعمل بشكل طبيعي.

### الخطوة 3: اختبار إنشاء مهمة بسيطة
اطلب:
```
أضف مهمة بسيطة اسمها "اختبار النظام" صعوبة easy و20 XP
```

### الخطوة 4: مراقبة رسائل الخطأ
افتح Developer Console (F12) وانظر إلى:
- Network tab: ابحث عن طلبات `/api/chat`
- Console tab: ابحث عن أخطاء JavaScript
- رسائل الخطأ من المرشد في الواجهة

## رسائل الخطأ المتوقعة وحلولها

### "معرف المشروع غير صحيح"
**السبب**: AI يستخدم معرف خاطئ أو `null`
**الحل**: 
- تأكد من أن `projectId` يُمرر بشكل صحيح في `useChat` body
- راجع `app/dashboard/[projectId]/ai/page.tsx` السطر 84-91

### "فشل التحقق من الهوية"
**السبب**: مشكلة في جلسة المستخدم
**الحل**:
- سجل خروج ثم دخول مرة أخرى
- امسح cookies المتصفح
- تحقق من أن Supabase session صالحة

### "المشروع غير موجود أو لا يمكنك الوصول إليه"
**السبب**: المعرف خاطئ أو المشروع لا ينتمي للمستخدم الحالي
**الحل**:
- تأكد من أنك تستخدم مشروعك الخاص
- تحقق من جدول `projects` في Supabase

## ملفات مهمة تم تعديلها

### 1. `lib/ai/tools.ts`
- تحسين معالجة الأخطاء في `createTaskTool`
- إضافة تحقق من صحة معرف المشروع
- رسائل خطأ أكثر وضوحاً بالعربية

### 2. `lib/ai/prompts.ts`
- إضافة تعليمات واضحة عن استخدام معرف المشروع
- التأكيد على أخذ المعرف من السياق

### 3. `app/api/chat/route.ts`
- عرض معرف المشروع بشكل واضح في أول سياق المحادثة
- إضافة تحذير لاستخدام المعرف الصحيح

## الحل الجذري المحتمل

إذا استمرت المشكلة، قد نحتاج إلى:

### الخيار A: نقل الأدوات إلى API Routes منفصلة
بدلاً من تنفيذ Server Actions مباشرة، نقوم بإنشاء API routes مخصصة:
```
/api/projects/[projectId]/tasks/create
/api/projects/[projectId]/tasks/update
/api/projects/[projectId]/tasks/delete
```

### الخيار B: تمرير Authentication Token
تمرير JWT token مع كل طلب أداة:
```typescript
body: {
  projectId,
  context: { ... },
  authToken: await getAccessToken()
}
```

## سجل التغييرات
- ✅ إضافة تحقق من صحة معرف المشروع
- ✅ تحسين رسائل الخطأ
- ✅ توضيح معرف المشروع في السياق
- ✅ تحديث تعليمات النظام للمرشد

## الخطوات التالية
1. اختبر إنشاء مهمة بسيطة
2. راقب رسائل الخطأ المحددة
3. إذا استمرت المشكلة، شارك رسالة الخطأ بالكامل
